# 明日方舟：终末地 抽卡计算器算法与逻辑详解

> [!NOTE]
> 文档由 Gemini 3 Pro (11/30/2025) 生成，计算逻辑经过人类检查与修正。

本文档旨在解释本在线计算器背后的数学模型、游戏机制假设以及两种核心算法（MCMC 与 动态规划）的实现原理。

## 1. 核心游戏机制假设

基于《明日方舟：终末地》技术测试（三测）的数据，本计算器采用以下数学模型。请注意，正式上线时数值可能会有所调整。

### 1.1 基础概率与保底 (Pity System)

- 单抽价格：500 嵌晶玉。

- 基础概率 ($P_{base}$)：0.8%。

- 软保底 (Soft Pity)：从第 66 抽开始，每一抽的六星获取概率提升 5.0%。

- 硬保底 (Hard Pity)：第 80 抽时概率达到 100%（实际上第 79 抽已达 75.8% + 0.8%）。

- 歪率 (Rate Up)：50% 为当期 UP，50% 为非 UP。

注：本作目前不存在“大保底”机制（即上一次歪了，下一次必中），每次出货判定都是独立的 50/50 事件。

### 1.2 特殊机制 (Special Mechanics)

这两个机制仅在**当期卡池**生效，且计算器会根据用户设定的“当期最大投入”来判定是否触发。

#### 1.2.1 120 井 (Spark System)

规则：若在当期卡池的前 119 抽中**未获得**任何当期 UP 角色，第 120 抽的结果将**强制**变为当期 UP 角色。

限制：该规则在**单期卡池中仅生效 1 次**。一旦玩家通过运气抽到 UP 或触发了该机制，该规则即刻失效。

影响：它截断了非酋的长尾分布，提供了一个硬性的止损点。

#### 1.2.2 240 里程碑 (Milestone System)

规则：当期卡池累计抽数每达到 **240** 的倍数（240, 480...），额外赠送 1 个当期 UP 角色的潜能。

性质：这是**额外获取**，不消耗当次的抽卡结果，也不重置水位（Pity）。

## 2. 计算逻辑流程

为了应对“玩家可能抽不完就停手，去等后续卡池歪”的情况，我们将计算逻辑拆分为两个阶段：

### 2.1 阶段一：当期强娶 (Current Banner Phase)

条件：累计投入抽数 $\le$ 用户设定的 当期最大投入 (MaxInvest)。

逻辑：

- 享受 **120 井** 的保护。

- 享受 **240 里程碑** 的赠送。

- 目标来源：抽卡出货（50% 概率） + 机制保底 + 机制赠送。

### 2.2 阶段二：后续等歪 (Future Spook Phase)

条件：当期投入已达上限，但仍未达成目标潜能。

逻辑：

- **不再享受** 120 井（新池子的井给新角色）。

- **不再享受** 240 赠送（新池子的赠送给新角色）。

- 目标来源：仅靠“歪”。

- 概率模型：在后续卡池出六星时，有 50% 概率歪；歪了之后，目标角色进入常驻池。假设常驻池有 $N$ 个角色，加上当期陪跑的 2 个，共 $N+2$ 个。

- 单次命中期望：$\text{六星期望} \div (0.5 \times \frac{1}{N_{std} + 2})$。

## 3. 算法原理

本计算器提供两种算法供用户选择：

### 3.1 动态规划 (Dynamic Programming, DP)

特点：计算速度极快，结果为精确的数学期望，适合大多数用户。

#### 状态定义

我们需要维护一个状态数组 $DP[t][p][k][s]$（实际实现中通过迭代压缩了 $t$ 维度）：

- $t$: 当前累计抽数。

- $p$: 当前水位 (Pity Count, 0~79)。

- $k$: 已获得目标角色数量。

- $s$: 120 井是否已消耗 (0 或 1)。

#### 状态转移方程

对于第 $t+1$ 抽，设当前出六星概率为 $R(p)$：

1. **判定 120 井**：若 $t+1 = 120$ 且 $s=0$，则直接转移到状态 $[0][k+1][1]$。

2. **常规出货**：

- **出金 ($R(p)$)**：

- **是 UP (0.5)**：转移至 $[0][k+1][1]$（井被标记消耗）。

- **是 歪 (0.5)**：转移至 $[0][k][s]$（水位重置，目标数不变）。

- **未出金 ($1-R(p)$)**：转移至 $[p+1][k][s]$。

3. **判定 240 赠送**：若 $(t+1) \% 240 == 0$，所有状态的 $k$ 统一加 1。

#### 期望计算

总期望 = (当期 DP 计算得出的期望抽数) + (剩余未毕业概率 $\times$ 未来等歪的单位期望成本)。

### 3.2 蒙特卡洛模拟 (MCMC)

特点：通过模拟数万名“虚拟玩家”的抽卡过程，统计出分布直方图。可以直观地展示“欧皇”和“非酋”的差距（标准差/方差）。

#### 模拟流程

对于每一次模拟（共 $N$ 次）：

1. 初始化水位、已抽数、目标数。

2. 进入 while (current_copies < target) 循环：

- 检查是否在“当期”投入范围内。

- **是**：执行当期逻辑（检查 120/240，执行 RNG 判定）。

- **否**：进入“未来模式”，仅执行 RNG 判定，且命中率大幅降低（仅靠歪）。

3. 记录该次模拟的总抽数。

4. 最终统计所有模拟结果的平均值、中位数和分布情况。

### 4. 关键数学公式

#### 4.1 单次出六星概率 $P(n)$

$$
P(n) = \begin{cases}
0.8\% & 1 \le n \le 65 \\
0.8\% + (n - 65) \times 5.0\% & 66 \le n \le 79 \\
100\% & n \ge 80
\end{cases}
$$

4.2 未来“等歪”成本期望

当进入“等歪模式”后，获得 1 个指定旧角色的期望抽数 $E_{future}$：

$$
E_{gold} \approx 62.3 \text{ (单六星期望抽数)}
$$

$$
P_{hit} = 0.5 \times \frac{1}{N_{std} + 2} \text{ (歪中目标概率)}
$$

$$
E_{future} = \frac{E_{gold}}{P_{hit}} = E_{gold} \times 2 \times (N_{std} + 2)
$$

其中 $N_{std}$ 为常驻六星数量。

## 5. 总结

120 井 极大地降低了单只角色的获取方差，消除了“千抽无UP”的极端情况。

240 赠送 对追求高潜能（满命）的玩家是巨大的利好，相当于每 240 抽提供一次额外的保底。

由于没有“大保底”（歪了下次必中），连续歪是可能发生的。在 120 抽之前，欧非差距主要体现在是否连续歪。
